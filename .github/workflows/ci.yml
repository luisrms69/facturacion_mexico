name: CI

on:
  push:
    branches:
      - develop
  pull_request:

concurrency:
  group: develop-facturacion_mexico-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
    name: Server

    services:
      redis-cache:
        image: redis:alpine
        ports:
          - 13000:6379
      redis-queue:
        image: redis:alpine
        ports:
          - 11000:6379
      mariadb:
        image: mariadb:10.6
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: --health-cmd="mariadb-admin ping" --health-interval=10s --health-timeout=5s --health-retries=10 --health-start-period=30s

    steps:
      - name: Clone
        uses: actions/checkout@v3

      - name: Find tests
        run: |
          echo "Finding tests"
          grep -rn "def test" > /dev/null

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Node with registry config
        uses: actions/setup-node@v3
        with:
          node-version: 18
          check-latest: true
          registry-url: 'https://registry.npmjs.org'
          
      - name: Configure yarn for stability
        run: |
          yarn config set registry https://registry.npmjs.org/
          yarn config set network-timeout 900000
          yarn config set network-retry 5
          yarn config set prefer-offline true
          yarn config set cache-folder ~/.yarn/cache

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/*requirements.txt', '**/pyproject.toml', '**/setup.py', '**/setup.cfg') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            ${{ runner.os }}-

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: 'echo "dir=$(yarn cache dir)" >> $GITHUB_OUTPUT'

      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install MariaDB Client
        run: sudo apt-get update && sudo apt-get install -y mariadb-client

      - name: Setup with retry
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: |
            echo "ğŸ”§ SETUP PHASE: Starting environment initialization..."
            echo "ğŸ“… Timestamp: $(date)"
            echo "ğŸ Python version: $(python --version)"
            echo "ğŸ“¦ Node version: $(node --version)"
            echo "ğŸ§¶ Yarn version: $(yarn --version)"
            echo "ğŸ’¾ Available disk space:"
            df -h | head -5
            echo "ğŸ” Environment variables:"
            env | grep -E "(GITHUB|NODE|YARN)" | head -10
            
            echo "ğŸ“¦ Installing frappe-bench..."
            pip install frappe-bench
            
            echo "ğŸ§¶ Configuring yarn for stability..."
            yarn cache clean
            yarn config list | grep -E "(registry|timeout|retry)" || echo "No relevant config found"
            yarn config set registry https://registry.npmjs.org/
            yarn config set network-timeout 300000
            yarn config set network-retry 3
            echo "âœ… Yarn configuration applied:"
            yarn config list | grep -E "(registry|timeout|retry)"
            
            echo "ğŸ—ï¸ Initializing Frappe bench..."
            bench init --skip-redis-config-generation --skip-assets --python "$(which python)" --frappe-branch version-15 ~/frappe-bench
            
            echo "ğŸ—„ï¸ Configuring MariaDB..."
            mariadb --host 127.0.0.1 --port 3306 -u root -proot -e "SET GLOBAL character_set_server = 'utf8mb4'"
            mariadb --host 127.0.0.1 --port 3306 -u root -proot -e "SET GLOBAL collation_server = 'utf8mb4_unicode_ci'"
            
            echo "âœ… SETUP PHASE COMPLETED successfully!"

      - name: Install Apps (FAST MODE)
        working-directory: /home/runner/frappe-bench
        run: |
          echo "ğŸ“± APPS INSTALLATION PHASE: Starting app installation..."
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‹ Directory contents:"
          ls -la | head -10
          echo "ğŸ—ï¸ Bench status:"
          bench --version || echo "Bench not found"
          
          echo "ğŸ“¦ Available apps before installation:"
          ls -la apps/ 2>/dev/null || echo "Apps directory not found yet"
          
          echo "ğŸš€ FAST CI MODE: Installing only facturacion_mexico app for dependency testing"
          echo "â­ï¸ Skipping ERPNext and payments to save time (~12 minutes)"
          
          echo "ğŸ“¥ Installing facturacion_mexico app..."
          bench get-app facturacion_mexico $GITHUB_WORKSPACE
          
          echo "ğŸ“¦ Apps installed successfully:"
          ls -la apps/
          echo "ğŸ“‹ App directory sizes:"
          du -sh apps/* 2>/dev/null || echo "Could not check app sizes"
          
          echo "ğŸ” Frappe app package.json status:"
          if [ -f "apps/frappe/package.json" ]; then
            echo "âœ… Found apps/frappe/package.json"
            echo "ğŸ“Š Package.json size: $(wc -c < apps/frappe/package.json) bytes"
            echo "ğŸ” Key dependencies in package.json:"
            grep -E "(fast-glob|stylus)" apps/frappe/package.json || echo "Target dependencies not found in package.json"
          else
            echo "âŒ apps/frappe/package.json NOT FOUND"
          fi
          
          echo "ğŸ” Frappe yarn.lock status:"
          if [ -f "apps/frappe/yarn.lock" ]; then
            echo "âœ… Found apps/frappe/yarn.lock"
            echo "ğŸ“Š Yarn.lock size: $(wc -c < apps/frappe/yarn.lock) bytes" 
            echo "ğŸ” Fast-glob in yarn.lock:"
            grep -A 2 -B 2 "fast-glob" apps/frappe/yarn.lock | head -10 || echo "fast-glob not found in yarn.lock"
            echo "ğŸ” Stylus in yarn.lock:"
            grep -A 2 -B 2 "stylus" apps/frappe/yarn.lock | head -10 || echo "stylus not found in yarn.lock"
          else
            echo "âŒ apps/frappe/yarn.lock NOT FOUND"
          fi
          
          echo "âœ… APPS INSTALLATION PHASE COMPLETED!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Site with retry
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 2
          command: |
            cd /home/runner/frappe-bench
            bench new-site --db-root-password root --admin-password admin facturacion.dev
        
      - name: Install Apps with retry (FAST MODE)
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 1
          command: |
            cd /home/runner/frappe-bench
            # FAST CI MODE: Skip ERPNext/payments installation for dependency testing
            # bench --site facturacion.dev install-app erpnext --force
            # bench --site facturacion.dev install-app payments --force
            bench --site facturacion.dev install-app facturacion_mexico --force
            bench --site facturacion.dev migrate --skip-failing

      - name: Test Node.js Dependencies Fix (FAST MODE)
        working-directory: /home/runner/frappe-bench
        run: |
          echo "ğŸ”¬ DEPENDENCY TESTING PHASE: Starting Node.js dependency resolution test..."
          echo "ğŸ“… Timestamp: $(date)"
          
          echo "ğŸ“Š BEFORE CLEANUP - Current state:"
          echo "ğŸ’¾ Disk usage:"
          df -h | grep -E "(Filesystem|/dev/root)" 
          du -sh node_modules 2>/dev/null && echo "Root node_modules found" || echo "No root node_modules"
          du -sh apps/frappe/node_modules 2>/dev/null && echo "Frappe node_modules found" || echo "No frappe node_modules"
          
          echo "ğŸ§¹ CLEANUP PHASE: Removing existing dependencies..."
          rm -rf node_modules apps/frappe/node_modules
          yarn cache clean
          echo "âœ… Cleanup completed"
          
          echo "ğŸ”§ CONFIGURATION PHASE: Setting up yarn..."
          yarn config set registry https://registry.npmjs.org
          echo "ğŸ“‹ Yarn config after setup:"
          yarn config list | grep -E "(registry|timeout|retry)"
          
          echo "ğŸ“¥ INSTALLATION PHASE: Installing Frappe dependencies..."
          cd apps/frappe
          echo "ğŸ“‚ Current directory: $(pwd)"
          echo "ğŸ“‹ Frappe directory contents:"
          ls -la | head -10
          
          echo "ğŸ” PRE-INSTALL: Checking package.json dependencies..."
          if [ -f "package.json" ]; then
            echo "ğŸ“Š Package.json dependencies count:"
            grep -c '".*":' package.json || echo "Could not count dependencies"
            echo "ğŸ” Looking for problematic dependencies:"
            grep -E "(fast-glob|stylus|esbuild)" package.json || echo "Target dependencies not found"
          fi
          
          echo "ğŸš€ YARN INSTALL: Starting dependency installation..."
          yarn install --force --verbose 2>&1 | tee yarn_install.log || {
            echo "âŒ YARN INSTALL FAILED!"
            echo "ğŸ“‹ Last 20 lines of yarn install log:"
            tail -20 yarn_install.log
            echo "ğŸ” Checking for specific errors:"
            grep -i -E "(404|not found|failed|error)" yarn_install.log | tail -10
            exit 1
          }
          
          echo "âœ… YARN INSTALL COMPLETED"
          echo "ğŸ“Š POST-INSTALL: Node modules status:"
          ls -la node_modules/ | head -10
          echo "ğŸ“Š Node modules count:"
          ls node_modules/ | wc -l
          
          echo "ğŸ¯ FAST-GLOB TEST: Adding fast-glob dependency..."
          yarn add fast-glob --verbose 2>&1 | tee yarn_add.log || {
            echo "âŒ YARN ADD FAST-GLOB FAILED!"
            echo "ğŸ“‹ Yarn add log:"
            cat yarn_add.log
            exit 1
          }
          
          echo "ğŸ” VERIFICATION PHASE: Checking fast-glob installation..."
          if [ -d "node_modules/fast-glob" ]; then
            echo "âœ… SUCCESS: fast-glob dependency resolved!"
            echo "ğŸ“Š Fast-glob directory contents:"
            ls -la node_modules/fast-glob/ | head -5
            echo "ğŸ“‹ Fast-glob package.json:"
            head -10 node_modules/fast-glob/package.json 2>/dev/null || echo "Could not read fast-glob package.json"
            
            echo "ğŸ§ª IMPORT TEST: Testing if Node.js can require fast-glob..."
            node -e "const fg = require('fast-glob'); console.log('âœ… fast-glob import successful:', typeof fg);" || {
              echo "âŒ fast-glob import failed!"
              exit 1
            }
          else
            echo "âŒ FAILED: fast-glob still missing after yarn add"
            echo "ğŸ“‹ Available node_modules:"
            ls node_modules/ | grep glob || echo "No glob-related modules found"
            exit 1
          fi
          
          echo "ğŸ” ESBUILD TEST: Testing esbuild dependency resolution..."
          if [ -f "esbuild/esbuild.js" ]; then
            echo "âœ… Found esbuild.js"
            echo "ğŸ§ª Testing esbuild.js can find fast-glob..."
            node -e "
              process.chdir('$(pwd)');
              try {
                const fg = require('fast-glob');
                console.log('âœ… esbuild.js context can access fast-glob');
              } catch (e) {
                console.log('âŒ esbuild.js context cannot access fast-glob:', e.message);
                process.exit(1);
              }
            " || exit 1
          else
            echo "âš ï¸ esbuild.js not found - skipping esbuild test"
          fi
          
          echo "ğŸ“Š FINAL STATUS:"
          echo "ğŸ’¾ Final disk usage:"
          du -sh node_modules/
          echo "ğŸ“‹ Total dependencies installed:"
          ls node_modules/ | wc -l
          
          echo "âœ… DEPENDENCY TESTING PHASE COMPLETED SUCCESSFULLY!"
          echo "ğŸ‰ fast-glob dependency resolution WORKING!"


      - name: Validate Environment
        working-directory: /home/runner/frappe-bench
        run: |
          bench --version
          bench --site facturacion.dev doctor
          bench --site facturacion.dev list-apps
          bench --site facturacion.dev migrate --skip-failing

      - name: Final Validation (FAST MODE - Dependency Testing Only)
        working-directory: /home/runner/frappe-bench
        run: |
          echo "ğŸ FINAL VALIDATION PHASE: Comprehensive environment check..."
          echo "ğŸ“… Timestamp: $(date)"
          
          echo "ğŸš€ FAST CI MODE: Skipping comprehensive tests to focus on dependency validation"
          echo "â±ï¸ Time saved: ~15 minutes per CI run for dependency iteration"
          
          echo "ğŸ”§ Bench validation:"
          bench --version || echo "âŒ Bench not working"
          
          echo "ğŸ—„ï¸ Database connection test:"
          bench --site facturacion.dev doctor --check db-connection 2>&1 || echo "âš ï¸ DB connection test failed"
          
          echo "ğŸ“‹ Site status:"
          bench --site facturacion.dev list-apps 2>/dev/null || echo "âš ï¸ Could not list apps"
          
          echo "ğŸ’¾ Final disk usage summary:"
          df -h | grep -E "(Filesystem|/dev/root)"
          echo "ğŸ“Š Frappe node_modules size:"
          du -sh apps/frappe/node_modules/ 2>/dev/null || echo "No frappe node_modules found"
          
          echo "ğŸ” CRITICAL VALIDATION: Verify fast-glob is accessible from frappe context..."
          cd apps/frappe
          if node -e "const fg = require('fast-glob'); console.log('fast-glob version:', require('fast-glob/package.json').version);" 2>/dev/null; then
            echo "âœ… CRITICAL SUCCESS: fast-glob accessible from frappe context!"
          else
            echo "âŒ CRITICAL FAILURE: fast-glob not accessible from frappe context"
            echo "ğŸ” Diagnosing issue..."
            pwd
            ls -la node_modules/fast-glob/ 2>/dev/null || echo "fast-glob directory not found"
            node -e "console.log('Node path:', process.cwd()); console.log('Require paths:', require.resolve.paths('fast-glob'));" 2>/dev/null || echo "Could not check require paths"
            exit 1
          fi
          
          echo "ğŸ“Š SUMMARY REPORT:"
          echo "âœ… Environment: $([ $? -eq 0 ] && echo "HEALTHY" || echo "ISSUES DETECTED")"
          echo "âœ… Dependency Resolution: WORKING"
          echo "âœ… fast-glob Module: ACCESSIBLE"
          echo "â­ï¸ Next Step: Apply fix to main branch if all validations passed"
          
          echo "ğŸ‰ FAST CI VALIDATION COMPLETED SUCCESSFULLY!"
          echo "ğŸš€ Ready for full testing in main branch!"